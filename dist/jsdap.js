!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.JsDap=e():t.JsDap=e()}(window,function(){return function(t){var e={};function r(n){if(e[n])return e[n].exports;var s=e[n]={i:n,l:!1,exports:{}};return t[n].call(s.exports,s,s.exports,r),s.l=!0,s.exports}return r.m=t,r.c=e,r.d=function(t,e,n){r.o(t,e)||Object.defineProperty(t,e,{configurable:!1,enumerable:!0,get:n})},r.r=function(t){Object.defineProperty(t,"__esModule",{value:!0})},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=4)}([function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t){if(t){var e=document.createElement("script");e.setAttribute("type","text/vbscript"),e.innerHTML="\n            Function BinaryToArray(Binary)\n Dim i\n ReDim byteArray(LenB(Binary))\n            For i = 1 To LenB(Binary)\n byteArray(i-1) = AscB(MidB(Binary, i, 1))\n            Next\n BinaryToArray = byteArray\n End Function\n ",document.head.appendChild(e)}}},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();function s(t,e){for(++e;--e;t=1073741824==(1073741824&(t%=2147483648))?2*t:2*(t-1073741824)+2147483647+1);return t}function a(t,e,r){if(e<0||r<=0)return 0;for(var n,a=e%8,i=t.length-(e>>3)-1,u=t.length+(-(e+r)>>3),o=i-u,c=(t[i]>>a&(1<<(o?8-a:r))-1)+(o&&(n=(e+r)%8)?(t[u++]&(1<<n)-1)<<(o--<<3)-a:0);o;c+=s(t[u++],(o--<<3)-a));return c}function i(t,e,r){var n=a(t,0,8*e),s=Math.pow(2,8*e);return r&&n>=s/2?n-s:n}function u(t,e,r){var n,s,i,u=Math.pow(2,r-1)-1,o=a(t,e+r,1),c=a(t,e,r),h=0,p=2,f=t.length+(-e>>3)-1;do{for(n=t[++f],i=1<<(s=e%8||8);i>>=1;n&i&&(h+=1/p),p*=2);}while(e-=s);return c==1+(u<<1)?h?NaN:o?-1/0:1/0:(1+-2*o)*(c||h?c?Math.pow(2,c-u)*(1+h):Math.pow(2,1-u)*h:0)}e.getBuffer=function(t){for(var e=new Array(t.length),r=0;r<t.length;r++)e[r]=255&t.charCodeAt(r);return e},e.dapUnpacker=function(){function t(e,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this._buf=e,this.dapvar=r,this._pos=0}return n(t,[{key:"getValue",value:function(){var t=this._pos,e=this.dapvar.type.toLowerCase();if("structure"==e||"dataset"==e){var r=[],n=this.dapvar;for(var s in n)n[s].type&&(this.dapvar=n[s],o=this.getValue(),r.push(o));return this.dapvar=n,r}if("grid"==e){for(var a in r=[],n=this.dapvar,this.dapvar=n.array,o=this.getValue(),r.push(o),n.maps)this.dapvar=n.maps[a],o=this.getValue(),r.push(o);return this.dapvar=n,r}if("sequence"==e){var i,u=this._unpack_uint32();for(r=[],n=this.dapvar;2768240640!=u;){for(var s in i=[],n)n[s].type&&(this.dapvar=n[s],o=this.getValue(),i.push(o));r.push(i),u=this._unpack_uint32()}return this.dapvar=n,r}if("Z\0\0\0"==this._buf.slice(t,t+4)){var o;for(u=this._unpack_uint32(),r=[];2768240640!=u;)o=this.getValue(),r.push(o),u=this._unpack_uint32();return r}var c=1;if(this.dapvar.shape.length&&(c=this._unpack_uint32(),"url"!=e&&"string"!=e&&this._unpack_uint32()),"byte"==e)r=this._unpack_bytes(c);else if("url"==e||"string"==e)r=this._unpack_string(c);else{var h;switch(r=[],e){case"float32":h="_unpack_float32";break;case"float64":h="_unpack_float64";break;case"int":h="_unpack_int32";break;case"uint":h="_unpack_uint32";break;case"int16":h="_unpack_int16";break;case"uint16":h="_unpack_uint16";break;case"int32":h="_unpack_int32";break;case"uint32":h="_unpack_uint32"}for(t=0;t<c;t++)r.push(this[h]())}return this.dapvar.shape?function t(e,r){if(!r.length)return e[0];for(var n,s,a,i=[],u=0;u<r[0];u++)a=(s=u*(n=e.length/r[0]))+n,i.push(t(e.slice(s,a),r.slice(1)));return i}(r,this.dapvar.shape):r[0]}},{key:"_unpack_byte",value:function(){var t=this._pos;return this._pos=t+1,i(this._buf.slice(t,t+1),1,!1)}},{key:"_unpack_uint16",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!1)}},{key:"_unpack_uint32",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!1)}},{key:"_unpack_int16",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!0)}},{key:"_unpack_int32",value:function(){var t=this._pos;return this._pos=t+4,i(this._buf.slice(t,t+4),4,!0)}},{key:"_unpack_float32",value:function(){var t=this._pos;return this._pos=t+4,u(this._buf.slice(t,t+4),23,8)}},{key:"_unpack_float64",value:function(){var t=this._pos;return this._pos=t+8,u(this._buf.slice(t,t+8),52,11)}},{key:"_unpack_bytes",value:function(t){for(var e=this._pos,r=[],n=0;n<t;n++)r.push(this._unpack_byte());var s=(4-t%4)%4;return this._pos=e+t+s,r}},{key:"_unpack_string",value:function(t){for(var e,r,n,s=[],a=0;a<t;a++){e=this._unpack_uint32(),u=this._pos,r=this._buf.slice(u,u+e),n=(4-e%4)%4,this._pos=u+e+n;for(var i="",u=0;u<e;u++)i+=String.fromCharCode(r[u]);s.push(i)}return s}}]),t}()},function(module,exports,__webpack_require__){"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}();function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var atomicTypes=["byte","int","uint","int16","uint16","int32","uint32","float32","float64","string","url","alias"],structures=["Sequence","Structure","Dataset"],IDENTIFIER_REGEX="[\\w-/]";function pseudoSafeEval(str){return/^[,:{}\[\]0-9.\-+Eaeflnr-u \n\r\t]*$/.test(str.replace(/\\./g,"@").replace(/"[^"\\\n\r]*"/g,""))?eval("("+str+")"):str}Array.prototype.contains=function(t){for(var e=0,r=this[e];e<this.length;r=this[++e])if(t==r)return!0;return!1},String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")},String.prototype.ltrim=function(){return this.replace(/^[\s\n\r\t]+/,"")},String.prototype.rtrim=function(){return this.replace(/\s+$/,"")};var dapType=function t(e){_classCallCheck(this,t),this.type=e,this.attributes={}},simpleParser=function(){function t(e){_classCallCheck(this,t),this.stream=e}return _createClass(t,[{key:"peek",value:function(t){var e=new RegExp("^"+t,"i"),r=this.stream.match(e);return r?r[0]:""}},{key:"consume",value:function(t){var e=new RegExp("^"+t,"i");this.stream=this.stream.replace(/(?:\r\n|\r|\n)/g,""),this.stream=this.stream.replace(/\\/g,"/");var r=this.stream.match(e);if(r)return this.stream=this.stream.substr(r[0].length).ltrim(),r[0];throw new Error("Unable to parse stream: "+this.stream.substr(0,10))}}]),t}(),ddsParser=exports.ddsParser=function(t){function e(t){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return r.dds=t,r}return _inherits(e,simpleParser),_createClass(e,[{key:"parse",value:function(){var t=new dapType("Dataset");for(this.consume("dataset"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}return this.consume("}"),t.id=t.name=this.consume("[^;]+"),this.consume(";"),function t(e,r){for(var n in e){var s=e[n];s.type&&(s.id=s.name,r&&(s.id=e.id+"."+s.id),t(s,!0))}}(t,!1),t}},{key:"_declaration",value:function(){switch(this.peek(IDENTIFIER_REGEX+"+").toLowerCase()){case"grid":return this._grid();case"structure":return this._structure();case"sequence":return this._sequence();default:return this._base_declaration()}}},{key:"_base_declaration",value:function(){var t=new dapType;for(t.type=this.consume(IDENTIFIER_REGEX+"+"),t.name=this.consume(IDENTIFIER_REGEX+"+"),t.dimensions=[],t.shape=[];!this.peek(";");){this.consume("\\[");var e=this.consume(IDENTIFIER_REGEX+"+");this.peek("=")&&(t.dimensions.push(e),this.consume("="),e=this.consume("\\d+")),t.shape.push(parseInt(e)),this.consume("\\]")}return this.consume(";"),t}},{key:"_grid",value:function(){var t=new dapType("Grid");for(this.consume("grid"),this.consume("{"),this.consume("array"),this.consume(":"),t.array=this._base_declaration(),this.consume("maps"),this.consume(":"),t.maps={};!this.peek("}");){var e=this._base_declaration();t.maps[e.name]=e}return this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),this.consume(";"),t}},{key:"_sequence",value:function(){var t=new dapType("Sequence");for(this.consume("sequence"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}return this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),this.consume(";"),t}},{key:"_structure",value:function(){var t=new dapType("Structure");for(this.consume("structure"),this.consume("{");!this.peek("}");){var e=this._declaration();t[e.name]=e}for(this.consume("}"),t.name=this.consume(IDENTIFIER_REGEX+"+"),t.dimensions=[],t.shape=[];!this.peek(";");){this.consume("\\[");var r=this.consume(IDENTIFIER_REGEX+"+");this.peek("=")&&(t.dimensions.push(r),this.consume("="),r=this.consume("\\d+")),t.shape.push(parseInt(r)),this.consume("\\]")}return this.consume(";"),t}}]),e}(),dasParser=exports.dasParser=function(t){function e(t,r){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.das=t,n.dataset=r,n}return _inherits(e,simpleParser),_createClass(e,[{key:"parse",value:function(){for(this._target=this.dataset,this.consume("attributes"),this.consume("{");!this.peek("}");)this._attr_container();return this.consume("}"),this.dataset}},{key:"_attr_container",value:function(){if(atomicTypes.contains(this.peek(IDENTIFIER_REGEX+"+").toLowerCase())){if(this._attribute(this._target.attributes),"Grid"==this._target.type)for(var t in this._target.maps)if(this.dataset[t]){var e=this._target.maps[e];for(var r in e.attributes)this.dataset[e].attributes[r]=e.attributes[r]}}else this._container()}},{key:"_container",value:function(){var t=this.consume("[\\w-_\\./]+");if(this.consume("{"),t.indexOf(".")>-1){for(var e=t.split("."),r=this._target,n=0;n<e.length;n++)this._target=this._target[e[n]];for(;!this.peek("}");)this._attr_container();this.consume("}"),this._target=r}else if(structures.contains(this._target.type)&&this._target[t]){var s=this._target;for(this._target=s[t];!this.peek("}");)this._attr_container();this.consume("}"),this._target=s}else this._target.attributes[t]=this._metadata(),this.consume("}")}},{key:"_metadata",value:function(){for(var t={};!this.peek("}");)if(atomicTypes.contains(this.peek(IDENTIFIER_REGEX+"+").toLowerCase()))this._attribute(t);else{var e=this.consume(IDENTIFIER_REGEX+"+");this.consume("{"),t[e]=this._metadata(),this.consume("}")}return t}},{key:"_attribute",value:function(t){for(var e=this.consume(IDENTIFIER_REGEX+"+"),r=this.consume(IDENTIFIER_REGEX+"+"),n=[];!this.peek(";");){var s=this.consume('".*?[^\\\\]"|[^;,]+');if("string"==e.toLowerCase()||"url"==e.toLowerCase())s=pseudoSafeEval(s);else if("alias"==e.toLowerCase()){var a=void 0,i=void 0;s.match(/^\\./)?(i=s.substring(1).split("."),a=this.dataset):(i=s.split("."),a=this._target);for(var u=0;u<i.length;u++){var o=i[u];s=a=a[o]?a[o]:a.array.name==o?a.array:a.maps[o]?a.maps[o]:a.attributes[o]}}else s="nan"==s.toLowerCase()?NaN:pseudoSafeEval(s);n.push(s),this.peek(",")&&this.consume(",")}this.consume(";"),1==n.length&&(n=n[0]),t[r]=n}}]),e}()},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(){function t(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}}(),s=r(2),a=r(1),i=function(t){return t&&t.__esModule?t:{default:t}}(r(0)),u=function(){function t(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.IE_HACK=e,(0,i.default)(this.IE_HACK)}return n(t,[{key:"proxyUrl",value:function(t,e,r,n,s){var i=void 0;if(window.XMLHttpRequest?i=new XMLHttpRequest:window.ActiveXObject&&(i=new window.ActiveXObject("Microsoft.XMLHTTP")),i.open("GET",t,!0),!0===s&&(i.withCredentials=!0),i.overrideMimeType?i.overrideMimeType("text/plain; charset=x-user-defined"):i.setRequestHeader("Accept-Charset","x-user-defined"),n)for(var u in n)i.setRequestHeader(u,n[u]);i.onreadystatechange=function(){4==i.readyState&&(r?this.IE_HACK?e(BinaryToArray(i.responseBody).toArray()):e((0,a.getBuffer)(i.responseText)):e(i.responseText))},i.send("")}},{key:"_applydata",value:function(t,e){var r=0;for(var n in e)e[n].type&&(e[n].data=t[r++],"Structure"==e[n].type&&this._applydata(e[n].data,e[n]))}},{key:"loadData",value:function(t,e,r,n){var i=this;this.proxyUrl(t,function(t){for(var r="";!r.match(/\nData:\n$/);){var n=t.splice(0,1);if(0===n.length)throw new Error("Error reading data, are you sur this is a .dods request ?");r+=String.fromCharCode(n)}r=r.substr(0,r.length-7);var u=new s.ddsParser(r).parse(),o=new a.dapUnpacker(t,u).getValue();i._applydata(o,u),e(u)},!0,r,n)}},{key:"loadDataset",value:function(t,e,r,n){var a=this;this.proxyUrl(t+".dds",function(i){var u=new s.ddsParser(i).parse();a.proxyUrl(t+".das",function(t){u=new s.dasParser(t,u).parse(),e(u)},!1,r,n)},!1,r,n)}}]),t}();e.default=u},function(t,e,r){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var n=function(t){return t&&t.__esModule?t:{default:t}}(r(3));e.default=n.default}]).default});
//# sourceMappingURL=jsdap.js.map